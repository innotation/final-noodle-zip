<!DOCTYPE html>
<html lang="en"
			xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{store/head :: head}"></head>



<body>
	<!-- header -->
	<th:block th:replace="~{store/header :: header}"></th:block>

	<main>
		
		<div class="container margin_detail">
		    <div class="row">
		        <div class="col-lg-8">
		            <div class="detail_page_head clearfix">
		                <div class="breadcrumbs">
		                    <ul>
		                        <li><a href="#">Home</a></li>
		                        <li><a href="#">Category</a></li>
		                        <li>Page active</li>
		                    </ul>
		                </div>
		                <div class="title">
		                    <h1 th:text="${store.storeName}">매장명</h1>
											<span th:text="${store.address}">주소</span>
											<a th:href="'https://map.naver.com/v5/search/' + ${store.storeName} + '?c=' + ${store.storeLng} + ',' + ${store.storeLat} + ',16,0,0'"
												 target="_blank">
												네이버 지도로 길찾기
											</a>
		                    <ul class="tags">
		                        <li><a href="#0">Pizza</a></li>
		                        <li><a href="#0">Italian Food</a></li>
		                        <li><a href="#0">Best Price</a></li>
		                    </ul>
		                </div>
									<!-- 이거 뭘로 바꾸지 -->
		                <div class="rating">
		                    <div class="score"><span>Superb<em>350 Reviews</em></span><strong>8.9</strong></div>
		                </div>
		            </div>
		            <!-- /detail_page_head -->

		            <div class="owl-carousel owl-theme carousel_1 magnific-gallery">
		                <div class="item">
		                    <a th:href="${store.storeMainImageUrl}" title="매장사진" data-effect="mfp-zoom-in">
													<img th:src="@{|${store.storeMainImageUrl} ?: '/img/detail_1.jpg'|}"
															 alt="store image"
															 onerror="this.onerror=null;this.src='/img/detail_1.jpg';">
												</a>
		                </div>
		            </div>
		            <!-- /carousel -->

		            <div class="tabs_detail">
		                <ul class="nav nav-tabs" role="tablist">
		                    <li class="nav-item">
		                        <a id="tab-A" href="#pane-A" class="nav-link active" data-bs-toggle="tab" role="tab">Information</a>
		                    </li>
												<li class="nav-item">
													<a id="tab-C" href="#pane-C" class="nav-link" data-bs-toggle="tab" role="tab">Menus</a>
												</li>
		                    <li class="nav-item">
		                        <a id="tab-B" href="#pane-B" class="nav-link" data-bs-toggle="tab" role="tab">Reviews</a>
		                    </li>
		                </ul>

		                <div class="tab-content" role="tablist">
		                    <div id="pane-A" class="card tab-pane fade show active" role="tabpanel" aria-labelledby="tab-A">
													<div th:replace="~{/store/fragments/tab-basic-info :: basic-info-tab}"></div>
		                    </div>
		                    <!-- /tab -->
											<input type="hidden" id="store-id" th:value="${store.id}">
											<div class="tab-pane fade" id="pane-C" role="tabpanel" aria-labelledby="tab-C"></div>
											<!-- tab-menu fragment -->

											<div class="tab-pane fade" id="pane-B" role="tabpanel" aria-labelledby="tab-B"></div>
											<!-- tab-review fragment-->

										</div>
									<!-- /tab-content -->
		            </div>
		            <!-- /tabs_detail -->
		        </div>
		        <!-- /col -->

		                <div class="col-lg-4" id="sidebar_fixed">
            <div class="box_booking">
                <div class="head">
                    <h3>매장 위치</h3>
                    <div class="offer">현재 위치</div>
                </div>
                <!-- /head -->
                <div class="main">
                    <div id="store_map" style="width: 100%; height: 300px; border-radius: 5px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
                    <div class="store_info" style="padding: 15px 0; border-top: 1px solid #eee;">
                        <h5 th:text="${store.storeName}" style="margin: 0 0 10px 0; color: #333; font-weight: 600;">매장명</h5>
                        <p th:text="${store.address}" style="margin: 0 0 8px 0; color: #666; font-size: 14px;">주소</p>
                        <p th:if="${store.phone}" th:text="'전화: ' + ${store.phone}" style="margin: 0; color: #666; font-size: 14px;">전화번호</p>
                    </div>
                    <a th:href="'https://map.naver.com/v5/search/' + ${store.storeName} + '?c=' + ${store.storeLng} + ',' + ${store.storeLat} + ',16,0,0'"
                       target="_blank" class="btn_1 full-width mb_5">
                        <i class="icon_location"></i> 네이버 지도에서 보기
                    </a>
                    <a href="wishlist.html" class="btn_1 full-width outline wishlist"><i class="icon_heart"></i> 위시리스트에 추가</a>
                </div>
            </div>
            <!-- /box_booking -->
            <ul class="share-buttons">
                <li><a class="fb-share" href="#0"><i class="social_facebook"></i> Share</a></li>
                <li><a class="twitter-share" href="#0"><i class="social_twitter"></i> Share</a></li>
                <li><a class="gplus-share" href="#0"><i class="social_googleplus"></i> Share</a></li>
            </ul>
        </div>

		    </div>
		    <!-- /row -->
		</div>
		<!-- /container -->
		
	</main>
	<!-- /main -->

	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const tabC = document.getElementById("tab-C");
			const paneC = document.getElementById("pane-C");
			const storeId = document.getElementById("store-id").value; // storeId를 숨겨놓고 가져옴

			let menuLoaded = false; // 중복 요청 방지

			tabC.addEventListener("click", () => {
				if (menuLoaded) return; // 이미 로드된 경우는 생략
				fetch(`/store/detail/${storeId}/menuList`)
					.then(response => {
						if (!response.ok) throw new Error("Menu tab load failed");
						return response.text();
					})
					.then(html => {
						paneC.innerHTML = html;
						initMenuFilter();
						menuLoaded = true;
					})
					.catch(err => {
						console.error(err);
					});
			});

			function initMenuFilter() {
					const tagEls = paneC.querySelectorAll(".filter-tag");
					const menuEls = paneC.querySelectorAll(".review_card");

					if (tagEls.length === 0 || menuEls.length === 0) return;

					const activeFilters = {
						category: new Set(),
						soup: new Set(),
						topping: new Set()
					};

					// 초기 활성화 상태 설정 (모든 태그가 기본적으로 활성화)
					tagEls.forEach(tag => {
						const type = tag.dataset.type;
						const value = tag.dataset.value;
						activeFilters[type].add(value);
						tag.classList.add("active"); // 모든 필터 태그를 초기에 active 상태로 설정
						tag.classList.remove("inactive"); // inactive 클래스 제거
					});


					tagEls.forEach(tag => {
						tag.addEventListener("click", () => {
							const type = tag.dataset.type;
							const value = tag.dataset.value;

							// active 클래스 토글
							tag.classList.toggle("active");
							if (tag.classList.contains("active")) {
								tag.classList.remove("inactive");
							} else {
								tag.classList.add("inactive");
							}

							if (activeFilters[type].has(value)) {
								activeFilters[type].delete(value);
							} else {
								activeFilters[type].add(value);
							}

							filterMenus();
						});
					});

					function filterMenus() {
						menuEls.forEach(menu => {
							const category = menu.dataset.category;
							const soup = menu.dataset.soup;
							const toppings = (menu.dataset.toppings || "").split(",");

							const categoryMatch = activeFilters.category.size === 0 || activeFilters.category.has(category);
							const soupMatch = activeFilters.soup.size === 0 || activeFilters.soup.has(soup);
							const toppingMatch = activeFilters.topping.size === 0 || toppings.some(t => activeFilters.topping.has(t.trim()));

							if (categoryMatch && soupMatch && toppingMatch) {
								menu.style.display = "";
							} else {
								menu.style.display = "none";
							}

							// 메뉴 카드 내 태그들의 활성화/비활성화 상태 업데이트
							const menuTags = menu.querySelectorAll(".widget.tags a");
							menuTags.forEach(menuTag => {
								const tagType = menuTag.dataset.type;
								const tagValue = menuTag.dataset.value;

								if (activeFilters[tagType] && activeFilters[tagType].has(tagValue)) {
									menuTag.classList.add("active");
									menuTag.classList.remove("inactive"); // Ensure inactive is removed
								} else {
									menuTag.classList.remove("active");
									menuTag.classList.add("inactive"); // Add inactive class
								}
							});
						});
					}
					filterMenus(); // Call filterMenus initially to set the correct display state
				}
		});
	</script>
	<!-- menu-tab 실행 -->


	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const tabB = document.getElementById("tab-B");
			const paneB = document.getElementById("pane-B");
			const storeId = document.getElementById("store-id").value;

			let reviewLoaded = false;

			tabB.addEventListener("click", () => {
				if (reviewLoaded) return;
				fetch(`/store/detail/${storeId}/reviews?page=1`)
					.then(res => res.text())
					.then(html => {
						paneB.innerHTML = html;
						initLoadMore();
						initReviewMenuFilter(); // 새로운 필터 초기화 함수 호출
						reviewLoaded = true;
					})
					.catch(err => console.error("리뷰 탭 로딩 실패", err));
			});

			function initLoadMore() {
				const container = document.getElementById("reviews");
				const loadMoreWrapper = document.getElementById("load-more-review-wrapper");
				if (!loadMoreWrapper) return;

				loadMoreWrapper.addEventListener("click", (e) => {
					const btn = e.target.closest("#load-more-review-btn");
					if (!btn) return;

					const nextPage = btn.dataset.nextPage;

					fetch(`/store/detail/${storeId}/reviews?page=${nextPage}`)
						.then(res => res.text())
						.then(html => {
							const tempDiv = document.createElement("div");
							tempDiv.innerHTML = html;

							const newCards = tempDiv.querySelectorAll(".review_card");
							const newWrapper = tempDiv.querySelector("#load-more-review-wrapper");

							newCards.forEach(card => container.appendChild(card));
							loadMoreWrapper.remove(); // 기존 버튼 제거
							if (newWrapper) container.after(newWrapper); // 새 버튼 삽입

							// 새로운 리뷰가 로드될 때마다 필터링 다시 적용
							filterReviewsByMenu();
						})
						.catch(err => console.error("더보기 실패", err));
				});
			}

			function initReviewMenuFilter() {
				const menuFilterTagsContainer = document.getElementById("menu-filter-tags");
				const reviewCards = document.querySelectorAll("#reviews .review_card");

				// 모든 메뉴 이름 추출 및 중복 제거
				const allMenuNames = new Set();
				reviewCards.forEach(card => {
					const menuName = card.dataset.menuName;
					if (menuName) {
						allMenuNames.add(menuName);
					}
				});

				// 기존 태그 초기화
				menuFilterTagsContainer.innerHTML = '';

				// '모두 보기' 태그 추가
				const allTag = document.createElement('a');
				allTag.href = '#0';
				allTag.classList.add('filter-tag', 'active');
				allTag.textContent = '모두 보기';
				allTag.dataset.menuName = 'all';
				menuFilterTagsContainer.appendChild(allTag);

				// 각 메뉴 이름에 대한 태그 추가
				allMenuNames.forEach(menuName => {
					const tag = document.createElement('a');
					tag.href = '#0';
					tag.classList.add('filter-tag');
					tag.textContent = menuName;
					tag.dataset.menuName = menuName;
					menuFilterTagsContainer.appendChild(tag);
				});

				// 태그 클릭 이벤트 리스너
				menuFilterTagsContainer.addEventListener('click', (e) => {
					const clickedTag = e.target.closest('.filter-tag');
					if (!clickedTag) return;

					// 모든 태그의 active 상태 초기화
					menuFilterTagsContainer.querySelectorAll('.filter-tag').forEach(tag => {
						tag.classList.remove('active');
					});

					// 클릭된 태그 활성화
					clickedTag.classList.add('active');

					filterReviewsByMenu();
				});

				// 초기 필터링 적용
				filterReviewsByMenu();
			}

			function filterReviewsByMenu() {
				const activeMenuTag = document.querySelector('#menu-filter-tags .filter-tag.active');
				const selectedMenuName = activeMenuTag ? activeMenuTag.dataset.menuName : 'all';
				const reviewCards = document.querySelectorAll('#reviews .review_card');

				reviewCards.forEach(card => {
					const cardMenuName = card.dataset.menuName;
					if (selectedMenuName === 'all' || cardMenuName === selectedMenuName) {
						card.style.display = '';
					} else {
						card.style.display = 'none';
					}
				});

				// 리뷰 요약 업데이트
				updateReviewSummary(selectedMenuName);
			}

			function updateReviewSummary(menuName) {
				const storeId = document.getElementById("store-id").value;
				let url = `/store/detail/${storeId}/reviews/summary/all`; // 기본은 전체 요약

				if (menuName !== 'all') {
					url = `/store/detail/${storeId}/reviews/summary?menuName=${encodeURIComponent(menuName)}`;
				}

				fetch(url)
					.then(response => {
						if (!response.ok) throw new Error("리뷰 요약 로드 실패");
						return response.json();
					})
					.then(summary => {
						// 리뷰 요약 영역 업데이트
						document.querySelector('#review_summary strong').textContent = summary.totalCount;
						document.querySelector('#review_summary em').textContent = '리뷰 수'; // 텍스트 고정
						document.querySelector('#review_summary small').textContent = '각 항목 별 리뷰 평균'; // 텍스트 고정

						// 각 항목별 평균 업데이트
						document.querySelector('.noodle-thickness-progress').style.width = (summary.noodleThickness * 10) + '%';
						document.querySelector('.noodle-thickness-value').textContent = summary.noodleThickness.toFixed(1);

						document.querySelector('.noodle-texture-progress').style.width = (summary.noodleTexture * 10) + '%';
						document.querySelector('.noodle-texture-value').textContent = summary.noodleTexture.toFixed(1);

						document.querySelector('.noodle-boil-level-progress').style.width = (summary.noodleBoilLevel * 10) + '%';
						document.querySelector('.noodle-boil-level-value').textContent = summary.noodleBoilLevel.toFixed(1);

						document.querySelector('.soup-temperature-progress').style.width = (summary.soupTemperature * 10) + '%';
						document.querySelector('.soup-temperature-value').textContent = summary.soupTemperature.toFixed(1);

						document.querySelector('.soup-saltiness-progress').style.width = (summary.soupSaltiness * 10) + '%';
						document.querySelector('.soup-saltiness-value').textContent = summary.soupSaltiness.toFixed(1);

						document.querySelector('.soup-spiciness-level-progress').style.width = (summary.soupSpicinessLevel * 10) + '%';
						document.querySelector('.soup-spiciness-level-value').textContent = summary.soupSpicinessLevel.toFixed(1);

						document.querySelector('.soup-oiliness-progress').style.width = (summary.soupOiliness * 10) + '%';
						document.querySelector('.soup-oiliness-value').textContent = summary.soupOiliness.toFixed(1);

					})
					.catch(err => console.error("리뷰 요약 업데이트 실패", err));
			}
		});
	</script>
<!--	<script th:src="@{/js/store_review_tab.js}"></script>-->
	<!-- review 탭 설정 script -->


	<!-- footer -->
	<th:block th:replace="~{fragments/footer :: footer}"></th:block>

	<div id="toTop"></div><!-- Back to top button -->
	
	<div class="layer"></div><!-- Opacity Mask Menu Mobile -->
	
	<!-- Sign In Modal -->
	<th:block th:replace="~{store/signin-modal :: signin-modal}"></th:block>

	    <!-- COMMON SCRIPTS -->
    <script src="/js/common_scripts.min.js"></script>
    <script src="/js/common_func.js"></script>
    <script src="/assets/validate.js"></script>
    
    <!-- SPECIFIC SCRIPTS -->
    <script src="/js/sticky_sidebar.min.js"></script>
    <script src="/js/specific_detail.js"></script>
	<script src="/js/datepicker.min.js"></script>
	<script src="/js/datepicker_func_1.js"></script>

    <!-- Naver Map API -->
    <script type="text/javascript"
            th:src="@{'https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId='
            + ${@environment.getProperty('naver.maps.client.id')}
            + '&submodules=geocoder,markerclusterer'}">
    </script>

    <!-- Store Map Script -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // 매장 위치 정보
            const storeLat = /*[[${store.storeLat}]]*/ 37.5665;
            const storeLng = /*[[${store.storeLng}]]*/ 126.9780;
            const storeName = /*[[${store.storeName}]]*/ '매장명';
            const storeAddress = /*[[${store.address}]]*/ '주소';
            
            // 지도 초기화
            const map = new naver.maps.Map('store_map', {
                center: new naver.maps.LatLng(storeLat, storeLng),
                zoom: 16,
                mapTypeControl: false,
                scaleControl: false,
                logoControl: false,
                mapDataControl: false,
                zoomControl: true,
                zoomControlOptions: {
                    position: naver.maps.Position.TOP_RIGHT
                }
            });
            
            // 매장 마커 생성
            const marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(storeLat, storeLng),
                map: map,
                title: storeName
            });
            
            // 인포 윈도우 생성
            const infoWindow = new naver.maps.InfoWindow({
                content: `
                    <div style="padding: 10px; min-width: 200px;">
                        <h6 style="margin: 0 0 5px 0; font-weight: bold;">${storeName}</h6>
                        <p style="margin: 0; font-size: 12px; color: #666;">${storeAddress}</p>
                    </div>
                `
            });
            
            // 마커 클릭 시 인포 윈도우 표시
            naver.maps.Event.addListener(marker, 'click', function() {
                if (infoWindow.getMap()) {
                    infoWindow.close();
                } else {
                    infoWindow.open(map, marker);
                }
            });
            
            // 페이지 로드 시 인포 윈도우 자동 표시
            setTimeout(() => {
                infoWindow.open(map, marker);
            }, 1000);
        });
    </script>

</body>
</html>