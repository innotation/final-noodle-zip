<!DOCTYPE html>
<html lang="en"
			xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{store/head :: head}"></head>



<body>
	<!-- header -->
	<th:block th:replace="~{store/header :: header}"></th:block>

	<main>
		
		<div class="container margin_detail">
		    <div class="row">
		        <div class="col-lg-8">
		            <div class="detail_page_head clearfix">
		                <div class="breadcrumbs">
		                    <ul>
		                        <li><a href="#">Home</a></li>
		                        <li><a href="#">Category</a></li>
		                        <li>Page active</li>
		                    </ul>
		                </div>
		                <div class="title">
		                    <h1 th:text="${store.storeName}">ë§¤ì¥ëª…</h1>
											<span th:text="${store.address}">ì£¼ì†Œ</span>
											<a th:href="'https://map.naver.com/v5/search/' + ${store.storeName} + '?c=' + ${store.storeLng} + ',' + ${store.storeLat} + ',16,0,0'"
												 target="_blank">
												ë„¤ì´ë²„ ì§€ë„ë¡œ ê¸¸ì°¾ê¸°
											</a>
		                    <ul class="tags">
		                        <li><a href="#0">Pizza</a></li>
		                        <li><a href="#0">Italian Food</a></li>
		                        <li><a href="#0">Best Price</a></li>
		                    </ul>
		                </div>
									<!-- ì´ê±° ë­˜ë¡œ ë°”ê¾¸ì§€ -->
		                <div class="rating">
		                    <div class="score"><span>Superb<em>350 Reviews</em></span><strong>8.9</strong></div>
		                </div>
		            </div>
		            <!-- /detail_page_head -->

		            <div class="owl-carousel owl-theme carousel_1 magnific-gallery">
		                <div class="item">
		                    <a th:href="${store.storeMainImageUrl}" title="ë§¤ì¥ì‚¬ì§„" data-effect="mfp-zoom-in">
													<img th:src="@{|${store.storeMainImageUrl} ?: '/img/detail_1.jpg'|}"
															 alt="store image"
															 onerror="this.onerror=null;this.src='/img/detail_1.jpg';">
												</a>
		                </div>
		            </div>
		            <!-- /carousel -->

		            <div class="tabs_detail">
		                <ul class="nav nav-tabs" role="tablist">
		                    <li class="nav-item">
		                        <a id="tab-A" href="#pane-A" class="nav-link active" data-bs-toggle="tab" role="tab">Information</a>
		                    </li>
												<li class="nav-item">
													<a id="tab-C" href="#pane-C" class="nav-link" data-bs-toggle="tab" role="tab">Menus</a>
												</li>
		                    <li class="nav-item">
		                        <a id="tab-B" href="#pane-B" class="nav-link" data-bs-toggle="tab" role="tab">Reviews</a>
		                    </li>
		                </ul>

		                <div class="tab-content" role="tablist">
		                    <div id="pane-A" class="card tab-pane fade show active" role="tabpanel" aria-labelledby="tab-A">
													<div th:replace="~{/store/fragments/tab-basic-info :: basic-info-tab}"></div>
		                    </div>
		                    <!-- /tab -->
											<input type="hidden" id="store-id" th:value="${store.id}">
											<div class="tab-pane fade" id="pane-C" role="tabpanel" aria-labelledby="tab-C"></div>
											<!-- tab-menu fragment -->

											<div class="tab-pane fade" id="pane-B" role="tabpanel" aria-labelledby="tab-B"></div>
											<!-- tab-review fragment-->

										</div>
									<!-- /tab-content -->
		            </div>
		            <!-- /tabs_detail -->
		        </div>
		        <!-- /col -->

		                <div class="col-lg-4" id="sidebar_fixed">
            <div class="box_booking">
                <div class="head">
                    <h3>ë§¤ì¥ ìœ„ì¹˜</h3>
                </div>
                <!-- /head -->
                <div class="main">
                    <div id="store_map" style="width: 100%; height: 300px; border-radius: 5px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
                    <div class="store_info" style="padding: 15px 0; border-top: 1px solid #eee;">
                        <h5 th:text="${store.storeName}" style="margin: 0 0 10px 0; color: #333; font-weight: 600;">ë§¤ì¥ëª…</h5>
                        <p th:text="${store.address}" style="margin: 0 0 8px 0; color: #666; font-size: 14px;">ì£¼ì†Œ</p>
                        <p th:if="${store.phone}" th:text="'ì „í™”: ' + ${store.phone}" style="margin: 0; color: #666; font-size: 14px;">ì „í™”ë²ˆí˜¸</p>
                    </div>
                    <a th:href="'https://map.naver.com/v5/search/' + ${store.storeName} + '?c=' + ${store.storeLng} + ',' + ${store.storeLat} + ',16,0,0'"
                       target="_blank" class="btn_1 full-width mb_5">
                        <i class="icon_location"></i> ë„¤ì´ë²„ ì§€ë„ì—ì„œ ë³´ê¸°
                    </a>
                    <a href="#" class="btn_1 full-width outline wishlist"><i class="icon_heart"></i> ìœ„ì‹œë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€</a>
                </div>
            </div>
            <!-- /box_booking -->
            <ul class="share-buttons">
                <li><a class="fb-share" href="#0"><i class="social_facebook"></i> Share</a></li>
                <li><a class="twitter-share" href="#0"><i class="social_twitter"></i> Share</a></li>
                <li><a class="gplus-share" href="#0"><i class="social_googleplus"></i> Share</a></li>
            </ul>
        </div>

		    </div>
		    <!-- /row -->
		</div>
		<!-- /container -->
		
	</main>
	<!-- /main -->

	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const tabC = document.getElementById("tab-C");
			const paneC = document.getElementById("pane-C");
			const storeId = document.getElementById("store-id").value; // storeIdë¥¼ ìˆ¨ê²¨ë†“ê³  ê°€ì ¸ì˜´

			let menuLoaded = false; // ì¤‘ë³µ ìš”ì²­ ë°©ì§€

			tabC.addEventListener("click", () => {
				if (menuLoaded) return; // ì´ë¯¸ ë¡œë“œëœ ê²½ìš°ëŠ” ìƒëµ
				fetch(`/store/detail/${storeId}/menuList`)
					.then(response => {
						if (!response.ok) throw new Error("Menu tab load failed");
						return response.text();
					})
					.then(html => {
						paneC.innerHTML = html;
						initMenuFilter();
						// DOM ë Œë”ë§ ì™„ë£Œ í›„ ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™”
						setTimeout(() => {
							initMenuGallery(); // ë©”ë‰´ ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™” ì¶”ê°€
						}, 100);
						menuLoaded = true;
					})
					.catch(err => {
						console.error(err);
					});
			});

			function initMenuFilter() {
					const tagEls = paneC.querySelectorAll(".filter-tag");
					const menuEls = paneC.querySelectorAll(".review_card");

					if (tagEls.length === 0 || menuEls.length === 0) return;

					const activeFilters = {
						category: new Set(),
						soup: new Set(),
						topping: new Set()
					};

					// ì´ˆê¸° í™œì„±í™” ìƒíƒœ ì„¤ì • (ëª¨ë“  íƒœê·¸ê°€ ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™”)
					tagEls.forEach(tag => {
						const type = tag.dataset.type;
						const value = tag.dataset.value;
						activeFilters[type].add(value);
						tag.classList.add("active"); // ëª¨ë“  í•„í„° íƒœê·¸ë¥¼ ì´ˆê¸°ì— active ìƒíƒœë¡œ ì„¤ì •
						tag.classList.remove("inactive"); // inactive í´ë˜ìŠ¤ ì œê±°
					});


					tagEls.forEach(tag => {
						tag.addEventListener("click", () => {
							const type = tag.dataset.type;
							const value = tag.dataset.value;

							// active í´ë˜ìŠ¤ í† ê¸€
							tag.classList.toggle("active");
							if (tag.classList.contains("active")) {
								tag.classList.remove("inactive");
							} else {
								tag.classList.add("inactive");
							}

							if (activeFilters[type].has(value)) {
								activeFilters[type].delete(value);
							} else {
								activeFilters[type].add(value);
							}

							filterMenus();
						});
					});

					function filterMenus() {
						menuEls.forEach(menu => {
							const category = menu.dataset.category;
							const soup = menu.dataset.soup;
							const toppings = (menu.dataset.toppings || "").split(",");

							const categoryMatch = activeFilters.category.size === 0 || activeFilters.category.has(category);
							const soupMatch = activeFilters.soup.size === 0 || activeFilters.soup.has(soup);
							const toppingMatch = activeFilters.topping.size === 0 || toppings.some(t => activeFilters.topping.has(t.trim()));

							if (categoryMatch && soupMatch && toppingMatch) {
								menu.style.display = "";
							} else {
								menu.style.display = "none";
							}

							// ë©”ë‰´ ì¹´ë“œ ë‚´ íƒœê·¸ë“¤ì˜ í™œì„±í™”/ë¹„í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
							const menuTags = menu.querySelectorAll(".widget.tags a");
							menuTags.forEach(menuTag => {
								const tagType = menuTag.dataset.type;
								const tagValue = menuTag.dataset.value;

								if (activeFilters[tagType] && activeFilters[tagType].has(tagValue)) {
									menuTag.classList.add("active");
									menuTag.classList.remove("inactive"); // Ensure inactive is removed
								} else {
									menuTag.classList.remove("active");
									menuTag.classList.add("inactive"); // Add inactive class
								}
							});
						});
					}
					filterMenus(); // Call filterMenus initially to set the correct display state
				}

				// ë©”ë‰´ ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™” í•¨ìˆ˜
				function initMenuGallery() {
					console.log('ë©”ë‰´ ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™” ì‹œì‘');
					
					// ë©”ë‰´ íƒ­ ë‚´ì˜ ëª¨ë“  ì´ë¯¸ì§€ ë§í¬ì— ëŒ€í•´ ì§ì ‘ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
					const menuImageLinks = paneC.querySelectorAll('a[data-effect="mfp-zoom-in"]');
					console.log('ì°¾ì€ ì´ë¯¸ì§€ ë§í¬:', menuImageLinks.length);
					
					menuImageLinks.forEach((link, index) => {
						console.log(`ë§í¬ ${index} ì„¤ì •:`, link.href);
						
						// ê¸°ì¡´ í´ë¦­ ì´ë²¤íŠ¸ ì œê±°
						link.removeEventListener('click', link._magnificHandler);
						
						// ìƒˆë¡œìš´ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
						link._magnificHandler = function(e) {
							e.preventDefault();
							console.log('ì´ë¯¸ì§€ í´ë¦­ë¨:', this.href);
							
							// Magnific Popupìœ¼ë¡œ ì´ë¯¸ì§€ ì—´ê¸°
							$.magnificPopup.open({
								items: {
									src: this.href
								},
								type: 'image',
								preloader: true,
								removalDelay: 500,
								callbacks: {
									beforeOpen: function () {
										this.st.image.markup = this.st.image.markup.replace('mfp-figure', 'mfp-figure mfp-with-anim');
										this.st.mainClass = 'mfp-zoom-in';
									}
								},
								closeOnContentClick: true,
								midClick: true
							});
						};
						
						link.addEventListener('click', link._magnificHandler);
					});
					
					console.log('ë©”ë‰´ ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™” ì™„ë£Œ');
				}
		});
	</script>
	<!-- menu-tab ì‹¤í–‰ -->


	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const tabB = document.getElementById("tab-B");
			const paneB = document.getElementById("pane-B");
			const storeId = document.getElementById("store-id").value;

			let reviewLoaded = false;

			tabB.addEventListener("click", () => {
				if (reviewLoaded) return;
				fetch(`/store/detail/${storeId}/reviews?page=1`)
					.then(res => res.text())
					.then(html => {
						paneB.innerHTML = html;
						initLoadMore();
						initReviewMenuFilter(); // ìƒˆë¡œìš´ í•„í„° ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
						// DOM ë Œë”ë§ ì™„ë£Œ í›„ ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™”
						setTimeout(() => {
							initReviewGallery(); // ë¦¬ë·° ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™” ì¶”ê°€
						}, 100);
						reviewLoaded = true;
					})
					.catch(err => console.error("ë¦¬ë·° íƒ­ ë¡œë”© ì‹¤íŒ¨", err));
			});

			function initLoadMore() {
				const container = document.getElementById("reviews");
				const loadMoreWrapper = document.getElementById("load-more-review-wrapper");
				if (!loadMoreWrapper) return;

				loadMoreWrapper.addEventListener("click", (e) => {
					const btn = e.target.closest("#load-more-review-btn");
					if (!btn) return;

					const nextPage = btn.dataset.nextPage;

					fetch(`/store/detail/${storeId}/reviews?page=${nextPage}`)
						.then(res => res.text())
						.then(html => {
							const tempDiv = document.createElement("div");
							tempDiv.innerHTML = html;

							const newCards = tempDiv.querySelectorAll(".review_card");
							const newWrapper = tempDiv.querySelector("#load-more-review-wrapper");

							newCards.forEach(card => container.appendChild(card));
							loadMoreWrapper.remove(); // ê¸°ì¡´ ë²„íŠ¼ ì œê±°
							if (newWrapper) container.after(newWrapper); // ìƒˆ ë²„íŠ¼ ì‚½ì…

							// ìƒˆë¡œìš´ ë¦¬ë·°ê°€ ë¡œë“œë  ë•Œë§ˆë‹¤ í•„í„°ë§ ë‹¤ì‹œ ì ìš©
							filterReviewsByMenu();
							
							// DOM ë Œë”ë§ ì™„ë£Œ í›„ ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™”
							setTimeout(() => {
								initReviewGallery(); // ìƒˆë¡œìš´ ë¦¬ë·°ì— ëŒ€í•´ì„œë„ ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™”
							}, 100);
						})
						.catch(err => console.error("ë”ë³´ê¸° ì‹¤íŒ¨", err));
				});
			}

			function initReviewMenuFilter() {
				const menuFilterTagsContainer = document.getElementById("menu-filter-tags");
				const reviewCards = document.querySelectorAll("#reviews .review_card");

				// ëª¨ë“  ë©”ë‰´ ì´ë¦„ ì¶”ì¶œ ë° ì¤‘ë³µ ì œê±°
				const allMenuNames = new Set();
				reviewCards.forEach(card => {
					const menuName = card.dataset.menuName;
					if (menuName) {
						allMenuNames.add(menuName);
					}
				});

				// ê¸°ì¡´ íƒœê·¸ ì´ˆê¸°í™”
				menuFilterTagsContainer.innerHTML = '';

				// 'ëª¨ë‘ ë³´ê¸°' íƒœê·¸ ì¶”ê°€
				const allTag = document.createElement('a');
				allTag.href = '#0';
				allTag.classList.add('filter-tag', 'active');
				allTag.textContent = 'ëª¨ë‘ ë³´ê¸°';
				allTag.dataset.menuName = 'all';
				menuFilterTagsContainer.appendChild(allTag);

				// ê° ë©”ë‰´ ì´ë¦„ì— ëŒ€í•œ íƒœê·¸ ì¶”ê°€
				allMenuNames.forEach(menuName => {
					const tag = document.createElement('a');
					tag.href = '#0';
					tag.classList.add('filter-tag');
					tag.textContent = menuName;
					tag.dataset.menuName = menuName;
					menuFilterTagsContainer.appendChild(tag);
				});

				// íƒœê·¸ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
				menuFilterTagsContainer.addEventListener('click', (e) => {
					const clickedTag = e.target.closest('.filter-tag');
					if (!clickedTag) return;

					// ëª¨ë“  íƒœê·¸ì˜ active ìƒíƒœ ì´ˆê¸°í™”
					menuFilterTagsContainer.querySelectorAll('.filter-tag').forEach(tag => {
						tag.classList.remove('active');
					});

					// í´ë¦­ëœ íƒœê·¸ í™œì„±í™”
					clickedTag.classList.add('active');

					filterReviewsByMenu();
				});

				// ì´ˆê¸° í•„í„°ë§ ì ìš©
				filterReviewsByMenu();
			}

			function filterReviewsByMenu() {
				const activeMenuTag = document.querySelector('#menu-filter-tags .filter-tag.active');
				const selectedMenuName = activeMenuTag ? activeMenuTag.dataset.menuName : 'all';
				const reviewCards = document.querySelectorAll('#reviews .review_card');

				reviewCards.forEach(card => {
					const cardMenuName = card.dataset.menuName;
					if (selectedMenuName === 'all' || cardMenuName === selectedMenuName) {
						card.style.display = '';
					} else {
						card.style.display = 'none';
					}
				});

				// ë¦¬ë·° ìš”ì•½ ì—…ë°ì´íŠ¸
				updateReviewSummary(selectedMenuName);
			}

			function updateReviewSummary(menuName) {
				const storeId = document.getElementById("store-id").value;
				let url = `/store/detail/${storeId}/reviews/summary/all`; // ê¸°ë³¸ì€ ì „ì²´ ìš”ì•½

				if (menuName !== 'all') {
					url = `/store/detail/${storeId}/reviews/summary?menuName=${encodeURIComponent(menuName)}`;
				}

				fetch(url)
					.then(response => {
						if (!response.ok) throw new Error("ë¦¬ë·° ìš”ì•½ ë¡œë“œ ì‹¤íŒ¨");
						return response.json();
					})
					.then(summary => {
						// ë¦¬ë·° ìš”ì•½ ì˜ì—­ ì—…ë°ì´íŠ¸
						document.querySelector('#review_summary strong').textContent = summary.totalCount;
						document.querySelector('#review_summary em').textContent = 'ë¦¬ë·° ìˆ˜'; // í…ìŠ¤íŠ¸ ê³ ì •
						document.querySelector('#review_summary small').textContent = 'ê° í•­ëª© ë³„ ë¦¬ë·° í‰ê· '; // í…ìŠ¤íŠ¸ ê³ ì •

						// ê° í•­ëª©ë³„ í‰ê·  ì—…ë°ì´íŠ¸
						document.querySelector('.noodle-thickness-progress').style.width = (summary.noodleThickness * 10) + '%';
						document.querySelector('.noodle-thickness-value').textContent = summary.noodleThickness.toFixed(1);

						document.querySelector('.noodle-texture-progress').style.width = (summary.noodleTexture * 10) + '%';
						document.querySelector('.noodle-texture-value').textContent = summary.noodleTexture.toFixed(1);

						document.querySelector('.noodle-boil-level-progress').style.width = (summary.noodleBoilLevel * 10) + '%';
						document.querySelector('.noodle-boil-level-value').textContent = summary.noodleBoilLevel.toFixed(1);

						document.querySelector('.soup-temperature-progress').style.width = (summary.soupTemperature * 10) + '%';
						document.querySelector('.soup-temperature-value').textContent = summary.soupTemperature.toFixed(1);

						document.querySelector('.soup-saltiness-progress').style.width = (summary.soupSaltiness * 10) + '%';
						document.querySelector('.soup-saltiness-value').textContent = summary.soupSaltiness.toFixed(1);

						document.querySelector('.soup-spiciness-level-progress').style.width = (summary.soupSpicinessLevel * 10) + '%';
						document.querySelector('.soup-spiciness-level-value').textContent = summary.soupSpicinessLevel.toFixed(1);

						document.querySelector('.soup-oiliness-progress').style.width = (summary.soupOiliness * 10) + '%';
						document.querySelector('.soup-oiliness-value').textContent = summary.soupOiliness.toFixed(1);

					})
					.catch(err => console.error("ë¦¬ë·° ìš”ì•½ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨", err));
			}

			// ë¦¬ë·° ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™” í•¨ìˆ˜
			function initReviewGallery() {
				console.log('ë¦¬ë·° ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™” ì‹œì‘');
				
				// ë¦¬ë·° íƒ­ ë‚´ì˜ ëª¨ë“  ì´ë¯¸ì§€ ë§í¬ì— ëŒ€í•´ ì§ì ‘ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
				const reviewImageLinks = paneB.querySelectorAll('a[data-effect="mfp-zoom-in"]');
				console.log('ì°¾ì€ ë¦¬ë·° ì´ë¯¸ì§€ ë§í¬:', reviewImageLinks.length);
				
				reviewImageLinks.forEach((link, index) => {
					console.log(`ë¦¬ë·° ë§í¬ ${index} ì„¤ì •:`, link.href);
					
					// ê¸°ì¡´ í´ë¦­ ì´ë²¤íŠ¸ ì œê±°
					link.removeEventListener('click', link._magnificHandler);
					
					// ìƒˆë¡œìš´ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
					link._magnificHandler = function(e) {
						e.preventDefault();
						console.log('ë¦¬ë·° ì´ë¯¸ì§€ í´ë¦­ë¨:', this.href);
						
						// Magnific Popupìœ¼ë¡œ ì´ë¯¸ì§€ ì—´ê¸°
						$.magnificPopup.open({
							items: {
								src: this.href
							},
							type: 'image',
							preloader: true,
							removalDelay: 500,
							callbacks: {
								beforeOpen: function () {
									this.st.image.markup = this.st.image.markup.replace('mfp-figure', 'mfp-figure mfp-with-anim');
									this.st.mainClass = 'mfp-zoom-in';
								}
							},
							closeOnContentClick: true,
							midClick: true
						});
					};
					
					link.addEventListener('click', link._magnificHandler);
				});
				
				console.log('ë¦¬ë·° ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™” ì™„ë£Œ');
			}
		});
	</script>
<!--	<script th:src="@{/js/store_review_tab.js}"></script>-->
	<!-- review íƒ­ ì„¤ì • script -->


	<!-- footer -->
	<th:block th:replace="~{fragments/footer :: footer}"></th:block>

	<div id="toTop"></div><!-- Back to top button -->
	
	<div class="layer"></div><!-- Opacity Mask Menu Mobile -->
	
	<!-- Sign In Modal -->
	<th:block th:replace="~{store/signin-modal :: signin-modal}"></th:block>

    <!-- ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ -->
    <div class="modal fade" id="wishlistModal" tabindex="-1" aria-labelledby="wishlistModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="wishlistModalLabel">ìœ„ì‹œë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="wishlistForm">
              <div class="mb-3">
                <label class="form-label">ì €ì¥í•  ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
                <div id="wishlist-category-list">
                  <!-- ì¹´í…Œê³ ë¦¬ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
              </div>
              <div class="mb-3">
                <label for="wishlistMemo" class="form-label">ë©”ëª¨ (ì„ íƒì‚¬í•­)</label>
                <textarea
                  class="form-control"
                  id="wishlistMemo"
                  rows="3"
                  maxlength="300"
                  placeholder="ì´ ê°€ê²Œì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                <div class="form-text">ìµœëŒ€ 300ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <button type="button" class="btn btn-outline-secondary" id="openAddCategoryModalBtn">+ ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
                <div>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                  <button type="button" class="btn btn-primary" id="saveWishlistBtn">ì €ì¥</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ëª¨ë‹¬ -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addCategoryModalLabel">ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="addCategoryForm">
              <div class="mb-3">
                <label for="addCategoryName" class="form-label">ì¹´í…Œê³ ë¦¬ëª…</label>
                <input type="text" class="form-control" id="addCategoryName" maxlength="30" required>
              </div>
              <div class="mb-3">
                <label class="form-label">ê³µê°œ ì—¬ë¶€</label>
                <div>
                  <input class="form-check-input" type="radio" name="addCategoryPublic" id="addCategoryPublicTrue" value="true" checked>
                  <label class="form-check-label me-3" for="addCategoryPublicTrue">ê³µê°œ</label>
                  <input class="form-check-input" type="radio" name="addCategoryPublic" id="addCategoryPublicFalse" value="false">
                  <label class="form-check-label" for="addCategoryPublicFalse">ë¹„ê³µê°œ</label>
                </div>
              </div>
              <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">ì¶”ê°€</button>
              </div>
            </form>
            <div id="addCategoryErrorMsg" style="color:red; margin-top:10px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ë¡œê·¸ì¸ ì•ˆë‚´ ëª¨ë‹¬ ì‚­ì œ -->
    <!--
    <div class="modal fade" id="loginRequiredModal" tabindex="-1" aria-labelledby="loginRequiredModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="loginRequiredModalLabel">ë¡œê·¸ì¸ í•„ìš”</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            ì´ ê¸°ëŠ¥ì€ ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
            <a href="/login" class="btn btn-primary mt-3 w-100">ë¡œê·¸ì¸ í•˜ëŸ¬ ê°€ê¸°</a>
          </div>
        </div>
      </div>
    </div>
    -->

	    <!-- COMMON SCRIPTS -->
    <script src="/js/common_scripts.min.js"></script>
    <script src="/js/common_func.js"></script>
    <script src="/assets/validate.js"></script>
    
    <!-- SPECIFIC SCRIPTS -->
    <script src="/js/sticky_sidebar.min.js"></script>
    <script src="/js/specific_detail.js"></script>
	<script src="/js/datepicker.min.js"></script>
	<script src="/js/datepicker_func_1.js"></script>

    <!-- Naver Map API -->
    <script type="text/javascript"
            th:src="@{'https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId='
            + ${@environment.getProperty('naver.maps.client.id')}
            + '&submodules=geocoder,markerclusterer'}">
    </script>

    <!-- Custom CSS for Gallery -->
    <style>
        /* ë©”ë‰´ì™€ ë¦¬ë·° ì´ë¯¸ì§€ì—ë§Œ ë‹ë³´ê¸° íš¨ê³¼ ì ìš© */
        #pane-C .magnific-gallery img,
        #pane-B .magnific-gallery img {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        #pane-C .magnific-gallery img:hover,
        #pane-B .magnific-gallery img:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        #pane-C .magnific-gallery a,
        #pane-B .magnific-gallery a {
            display: block;
            position: relative;
        }
        
        #pane-C .magnific-gallery a::after,
        #pane-B .magnific-gallery a::after {
            content: 'ğŸ”';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #pane-C .magnific-gallery a:hover::after,
        #pane-B .magnific-gallery a:hover::after {
            opacity: 1;
        }
      /* í…œí”Œë¦¿ í¬ì¸íŠ¸ ì»¬ëŸ¬ì— ë§ì¶˜ ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ */
      .wishlist.active, .wishlist.wishlist-active {
        color: #007bff !important;
        border-color: #007bff !important;
        background: #eaf4ff !important;
      }
    </style>

    <!-- Store Map Script -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // ë§¤ì¥ ìœ„ì¹˜ ì •ë³´
            const storeLat = /*[[${store.storeLat}]]*/ 37.5665;
            const storeLng = /*[[${store.storeLng}]]*/ 126.9780;
            const storeName = /*[[${store.storeName}]]*/ 'ë§¤ì¥ëª…';
            const storeAddress = /*[[${store.address}]]*/ 'ì£¼ì†Œ';
            
            // ì§€ë„ ì´ˆê¸°í™”
            const map = new naver.maps.Map('store_map', {
                center: new naver.maps.LatLng(storeLat, storeLng),
                zoom: 16,
                mapTypeControl: false,
                scaleControl: false,
                logoControl: false,
                mapDataControl: false,
                zoomControl: true,
                zoomControlOptions: {
                    position: naver.maps.Position.TOP_RIGHT
                }
            });
            
            // ë§¤ì¥ ë§ˆì»¤ ìƒì„±
            const marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(storeLat, storeLng),
                map: map,
                title: storeName
            });
            
            // ì¸í¬ ìœˆë„ìš° ìƒì„±
            const infoWindow = new naver.maps.InfoWindow({
                content: `
                    <div style="padding: 10px; min-width: 200px;">
                        <h6 style="margin: 0 0 5px 0; font-weight: bold;">${storeName}</h6>
                        <p style="margin: 0; font-size: 12px; color: #666;">${storeAddress}</p>
                    </div>
                `
            });
            
            // ë§ˆì»¤ í´ë¦­ ì‹œ ì¸í¬ ìœˆë„ìš° í‘œì‹œ
            naver.maps.Event.addListener(marker, 'click', function() {
                if (infoWindow.getMap()) {
                    infoWindow.close();
                } else {
                    infoWindow.open(map, marker);
                }
            });
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸í¬ ìœˆë„ìš° ìë™ í‘œì‹œ
            setTimeout(() => {
                infoWindow.open(map, marker);
            }, 1000);
        });
    </script>

    <!-- ë¡œê·¸ì¸ ì—¬ë¶€ hidden input ìˆ˜ì • -->
    <input type="hidden" id="is-logged-in"
      th:value="${#authentication.authenticated and #authentication.principal instanceof T(org.springframework.security.core.userdetails.UserDetails)}" />

    <script>
    document.addEventListener('DOMContentLoaded', function() {
      var isLoggedIn = document.getElementById('is-logged-in').value === 'true';
      var storeIdInput = document.getElementById('store-id');
      var storeId = storeIdInput ? storeIdInput.value : null;
      var wishlistBtn = document.querySelector('.wishlist');
      var lastSavedCategoryIds = [];

      // 1. í˜ì´ì§€ ì§„ì… ì‹œ ë²„íŠ¼ í™œì„±í™” - isSavedStore API ì‚¬ìš©
      if (isLoggedIn && storeId && wishlistBtn) {
        fetch(`/stores/${storeId}/saved-store/check`)
          .then(res => res.json())
          .then(isSaved => {
            if (isSaved) {
              wishlistBtn.classList.add('active');
            } else {
              wishlistBtn.classList.remove('active');
            }
          })
          .catch(err => {
            console.error('ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', err);
            wishlistBtn.classList.remove('active');
          });
      }

      // 2. ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ë²„íŠ¼ í´ë¦­ ì‹œ
      if (wishlistBtn) {
        wishlistBtn.addEventListener('click', function(e) {
          e.preventDefault();
          if (!isLoggedIn) {
            $.magnificPopup.open({
              items: {
                src: '#sign-in-dialog',
                type: 'inline'
              },
              removalDelay: 500,
              mainClass: 'my-mfp-zoom-in'
            });
            return;
          }
          const storeId = document.getElementById("store-id").value;

          fetch(`/stores/${storeId}/saved-store/memo`)
            .then(response => response.text())
            .then(memo => {
              document.getElementById("wishlistMemo").value = memo;
            })
            .catch(err => console.error("ë©”ëª¨ ë¡œë”© ì‹¤íŒ¨", err));

          // fetchë¡œ ëª©ë¡ ë°›ì•„ì™€ì„œ ì²´í¬ë°•ìŠ¤ ë Œë”ë§ í›„ ëª¨ë‹¬ ì˜¤í”ˆ
          fetch(`/stores/${storeId}/saved-store/categoryList`)
            .then(res => res.json())
            .then(data => {
              var listDiv = document.getElementById('wishlist-category-list');
              listDiv.innerHTML = '';
              lastSavedCategoryIds = [];
              data.forEach(cat => {
                if (cat.active) lastSavedCategoryIds.push(String(cat.categoryId));
                var checked = cat.active ? 'checked' : '';
                listDiv.innerHTML += `
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${cat.categoryId}" id="wishlist-cat-${cat.categoryId}" ${checked}>
                    <label class="form-check-label" for="wishlist-cat-${cat.categoryId}">
                      ${cat.categoryName}
                    </label>
                  </div>
                `;
              });
              var wishlistModal = new bootstrap.Modal(document.getElementById('wishlistModal'));
              wishlistModal.show();
            })
            .catch(() => alert('ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'));
        });
      }


      // 3. ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
      var saveBtn = document.getElementById('saveWishlistBtn');
      if (saveBtn) {
        saveBtn.addEventListener('click', function() {
          var checkedBoxes = document.querySelectorAll('#wishlist-category-list input[type="checkbox"]:checked');
          var categoryIds = Array.from(checkedBoxes).map(cb => cb.value);

          var memo = document.getElementById('wishlistMemo').value.trim();

          if (memo.length > 300) {
            showWishlistError('ë©”ëª¨ëŠ” ìµœëŒ€ 300ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
          }

          if (categoryIds.length === 0 && lastSavedCategoryIds.length === 0) {
            showWishlistError('ì¹´í…Œê³ ë¦¬ë¥¼ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”!');
            return;
          }

          // ëª¨ë“  ì²´í¬ëœ ì¹´í…Œê³ ë¦¬ IDë§Œ ì „ì†¡
          var checkedCategoryIds = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
          fetch(`/stores/${storeId}/saved-store/save`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
              storeId: parseInt(storeId), 
              saveStoreCategoryIds: checkedCategoryIds,
              memo: memo
            })
          })
          .then(res => {
            if (res.ok) {
              var wishlistModal = bootstrap.Modal.getInstance(document.getElementById('wishlistModal'));
              wishlistModal.hide();
              // ì €ì¥ í›„ ë²„íŠ¼ ìƒíƒœ ë‹¤ì‹œ í™•ì¸
              if (wishlistBtn && isLoggedIn && storeId) {
                fetch(`/stores/${storeId}/saved-store/check`)
                  .then(res => res.json())
                  .then(isSaved => {
                    if (isSaved) {
                      wishlistBtn.classList.add('active');
                    } else {
                      wishlistBtn.classList.remove('active');
                    }
                  })
                  .catch(err => {
                    console.error('ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', err);
                  });
              }
            } else {
              showWishlistError('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
          })
          .catch(() => showWishlistError('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
        });
      }

      // 4. ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€
      var addCategoryBtn = document.getElementById('openAddCategoryModalBtn');
      if (addCategoryBtn) {
        addCategoryBtn.addEventListener('click', function() {
          var addCategoryModal = new bootstrap.Modal(document.getElementById('addCategoryModal'));
          addCategoryModal.show();
        });
      }

      // 5. ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ëª¨ë‹¬ ì œì¶œ ì‹œ
      var addCategoryForm = document.getElementById('addCategoryForm');
      if (addCategoryForm) {
        addCategoryForm.addEventListener('submit', function(e) {
          e.preventDefault();
          var categoryName = document.getElementById('addCategoryName').value.trim();
          var isPublic = document.getElementById('addCategoryPublicTrue').checked;

          if (!categoryName) {
            showWishlistError('ì¹´í…Œê³ ë¦¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
          }

          fetch(`/stores/${storeId}/saved-store/add-category`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              storeId: parseInt(storeId),
              categoryName: categoryName,
              isPublic: isPublic
            })
          })
          .then(res => {
            if (res.ok) {
              var addCategoryModal = bootstrap.Modal.getInstance(document.getElementById('addCategoryModal'));
              addCategoryModal.hide();
              // ìƒˆë¡œ ì¶”ê°€ëœ ì¹´í…Œê³ ë¦¬ë¥¼ ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ëª©ë¡ì— ë°˜ì˜
              fetch(`/stores/${storeId}/saved-store/categoryList`)
                .then(res => res.json())
                .then(data => {
                  var listDiv = document.getElementById('wishlist-category-list');
                  listDiv.innerHTML = '';
                  lastSavedCategoryIds = [];
                  data.forEach(cat => {
                    if (cat.active) lastSavedCategoryIds.push(String(cat.categoryId));
                    var checked = cat.active ? 'checked' : '';
                    listDiv.innerHTML += `
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${cat.categoryId}" id="wishlist-cat-${cat.categoryId}" ${checked}>
                        <label class="form-check-label" for="wishlist-cat-${cat.categoryId}">
                          ${cat.categoryName}
                        </label>
                      </div>
                    `;
                  });
                })
                .catch(() => showWishlistError('ì¹´í…Œê³ ë¦¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
            } else {
              showWishlistError('ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
          })
          .catch(() => showWishlistError('ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
        });
      }

      function showWishlistError(msg) {
        var errMsg = document.getElementById('wishlist-error-msg');
        if (!errMsg) {
          errMsg = document.createElement('div');
          errMsg.id = 'wishlist-error-msg';
          errMsg.style.color = 'red';
          errMsg.style.marginTop = '10px';
          document.getElementById('wishlistForm').appendChild(errMsg);
        }
        errMsg.textContent = msg;
      }
    });
    </script>

</body>
</html>